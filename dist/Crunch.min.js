!function(t,n){if("function"==typeof define&&define.amd)define("Crunch",["module"],n);else if("undefined"!=typeof exports)n(module);else{var e={exports:{}};n(e),t.Crunch=e.exports}}(this,function(t){"use strict";function n(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function e(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n}function r(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)}function i(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}function o(t){var n=arguments.length<=1||void 0===arguments[1]?"":arguments[1];for(var e in t)L.call(t,e)&&(t[e]=n+e);return t}function a(){return++W}function u(t){return function(n){return z.call(n)===t}}function s(){var t=this,n=arguments[0],e=Y.call(arguments,1);return!G.isFunction(n)&&G.isFunction(e[0])&&(t=arguments[0],n=e.shift()),function(){var r=Y.call(arguments);return n.apply(t,[].concat(e,r))}}function c(t,n,e){var r=this;return setTimeout(function(){n.apply(r,e||[])},t||0)}function l(t,n){return G.isFunction(t)?function(e){return t.apply(n||this,e)}:G.isBuddy(t)?function(e){return Z.staticParentTask=n,t.run.apply(t,e)}:function(t){return t}}function f(t){return G.isFunction(t)||G.isBuddy(t)}function d(t,n,e){if(e||G.isFunction(e)){for(var r=n.split(/\s*,\s*/),i=void 0,o=void 0,a=arguments.length,u=Array(a>3?a-3:0),s=3;a>s;s++)u[s-3]=arguments[s];for(;i=r.shift();)(o=t[i])?o.push([e,u]):t[i]=[[e,u]]}}function p(t,n){if(t[n]){for(var e=t[n],r=arguments.length,i=Array(r>2?r-2:0),o=2;r>o;o++)i[o-2]=arguments[o];for(var a,u,s=0,c=e.length;c>s;s++)if(a=e[s][0],u=e[s][1],a)try{a.apply(this,[].concat(u,i))}catch(l){tt.debug&&console.log(l+", stack: "+l.stack)}}}function h(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return{on:d.bind(t,n),trigger:p.bind(t,n)}}function v(t,n){return G.isFunction(t)&&(n=t,t=this),G.isFunction(n)||(n=function(){}),function(){var e=nt.call(arguments,0);try{return n.apply(t,e),!0}catch(r){return Z.staticLastSafeError=r,tt.debug&&console.log(r+", stack: "+r.stack),!1}}}function g(){var t=Y.call(arguments,0);return function(){for(var n,e=Y.call(arguments,0),r=[].concat(t);(n=r.shift())&&G.isFunction(n);)n.apply(this,e)}}function y(t,n){tt.trace&&(console.log("inside proceedBodyFn",this.id,new Date-0),console.log("isFirstTime",n),console.log("this.timeoutAmount",this.timeoutAmount)),c.call(this,n?0:this.timeoutAmount,function(t){tt.trace&&console.log("inside proceedBodyFn:defer",this.id,new Date-0);var n,e,r,i,o=this.task,a=this.needRepeat,u=G.isNumber(a)?a:0,s=0,c=0,l=this.state===U.running&&!o.isPaused&&!o.isAborted;if(l){n=new Date;do{try{e=new Date,this.bodyFn(t.resolve,t.reject,t.sendNotify,{batchStarted:n,batchIndex:s,batchElapsed:c,runBlock:this.runBlock})}catch(f){tt.debug&&console.log(f+", stack: "+f.stack),t.signalError("body",f)}c+=new Date-e,s++,r=a&&0!==u&&u>c&&this.state===U.running}while(r)}else(o.isAborted||this.state===U.aborted)&&t.reject("aborted");return(i=a&&_[this.state]&&!o.isAborted)?(this.runBlock++,tt.trace&&console.log("rescheduling proceedBodyFn",this.id,new Date-0),y.call(this,t)):(a===!1&&t.resolve(),void(this.finallyFn&&!this.finallyFn.call(this,N[this.state])&&t.signalError("CrunchTask.description.fin",this.status)))},[t])}function b(t){var n=this,e=n.task,r=n.descriptionFn;if(!r)return t.signalError("CrunchTask.description.empty","Description function is empty. Ctx:"+JSON.stringify(n));if(tt.trace&&console.log("before descriptionFn run",new Date-0),!v(e,r)(t.setupInit,t.setupBody,t.setupFin)||M[n.state]||0!==n.conditionsToMeet)return t.signalError("CrunchTask.description.else","");tt.trace&&console.log("after descriptionFn run",new Date-0);var i=n.needRepeat;i=i===!1?i:0===i?i:i||tt.timeLimit,n.needRepeat=0===i?!0:i,n.timeoutAmount=n.timeoutAmount||tt.timeoutAmount,tt.trace&&(console.log("collected `needRepeat`:",n.needRepeat),console.log("collected `timeoutAmount`:",n.timeoutAmount)),t.goRunning(),tt.trace&&console.log("before deferred Init + Body scheduler",new Date-0),c.call(n,0,function(){tt.trace&&console.log("inside deferred Init + Body scheduler. With args:",new Date-0,this.runArgs.join()),this.initFn&&!this.initFn.apply(this,this.runArgs)&&t.signalError("CrunchTask.description.init"),tt.trace&&console.log("before  proceedBodyFn",new Date-0),y.call(this,t,!0)})}function m(t,n){throw G.isUndefined(n)&&(n=t,t="Generic"),new rt(t,n)}function k(t,n){for(var e=new Array(t.length),r=0,i=t.length;i>r;r++)e[r]=n(t[r],r);return e}function w(){return k(this.data,function(t){return t.current})}function A(t){return k(t,T)}function T(t){var n=t.length,e=n-1,r=G.isBoolean(t[e]),i=void 0;switch(n-(r?1:0)){case 2:case 3:return i=n-(r?1:0)===3?t[2]:t[0]<=t[1]?1:-1,{from:t[0],current:t[0],to:t[1],step:i,inclusive:r?t[n-1]:!1};case 0:case 1:m("Ranges","Use at least two values to define a range.");break;default:n%2===0&&n%3===0?m("Ranges","Use arrays to split range parts. Cannot determine pattern now."):m("Ranges","Use arrays to split range parts properly.")}}function O(t,n){for(var e=[],r=[],i=void 0,o=void 0;t.length;)i=t.splice(0,1)[0],o=G.isArray(i),o&&n!==!0?(r.length&&(e.push(r),r=[]),e.push(O(i,!0))):G.isBoolean(i)?(r.push(i),e.push(r),r=[]):G.isNumber(i)&&r.push(i);return r.length&&e.push(r),n===!0?e[0]:e}function F(){for(var t=arguments.length,n=Array(t),e=0;t>e;e++)n[e]=arguments[e];for(var r=n.length,i=0;f(n[r-1-i]);)i++;var o=n.slice(0,r-i),a=new it(o),u=n.slice(-i),s=x(u,2),c=s[0],l=s[1],d=void 0===l?function(){}:l;return c?j(a,c,d):ot()}function j(t,n,e){var r=G.getTaskType();return new r(function(r,i,o){var a=l(n,this),u=l(e,this),s=t,c=void 0;r(function(){for(var t=arguments.length,n=Array(t),e=0;t>e;e++)n[e]=arguments[e];n.length&&(s=new it(n)),c=s.canAdvance(!0)}),i(function(t){c&&a(s.valueOf()),c&&s.canAdvance()||t()},tt.timeLimit,tt.timeoutAmount),o(function(){u(s.valueOf())})})}function C(t,n,e){var r=G.getTaskType();return new r(function(r,i,o){var a=l(n,this),u=l(e,this),s=void 0,c=void 0,f=t,d=void 0;r(function(n){n&&(f=t),s=new it([0,f.length]),d=s.canAdvance(!0)}),i(function(t){d&&(c=s.valueOf()[0],a([f[c],c])),d&&s.canAdvance()||t()},tt.timeLimit,tt.timeoutAmount),o(function(){u(s.valueOf())})})}function E(){for(var t=arguments.length,n=Array(t),e=0;t>e;e++)n[e]=arguments[e];return new it(n)}function B(t,n,e,r){var i=G.getTaskType();return new i(function(i,o,a){var u=l(e,this),s=l(r,this),c=void 0,f=void 0,d=t,p=n,h=void 0;i(function(n,e){n&&(d=t),c=new it([0,d.length]),h=c.canAdvance(!0),G.isUndefined(e)||(p=e)}),o(function(t){h&&(f=c.valueOf()[0],p=u([p,d[f],f])),h&&c.canAdvance()||t(p)},tt.timeLimit,tt.timeoutAmount),a(function(){s(p,c.valueOf())})})}for(var S,P,D,x=(function(){function t(t,n){var e=[],r=!0,i=!1,o=void 0;try{for(var a,u=t[Symbol.iterator]();!(r=(a=u.next()).done)&&(e.push(a.value),!n||e.length!==n);r=!0);}catch(s){i=!0,o=s}finally{try{!r&&u["return"]&&u["return"]()}finally{if(i)throw o}}return e}return function(n,e){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return t(n,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}()),I=(function(){function t(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(n,e,r){return e&&t(n.prototype,e),r&&t(n,r),n}}()),L={}.hasOwnProperty,R=o({run:null,done:null,fail:null,abort:null,error:null,progress:null,idle:null},"event."),U=o({init:null,error:null,running:null,paused:null,resolved:null,rejected:null,aborted:null},"state."),_=(S={},i(S,U.running,!0),i(S,U.paused,!0),S),N=(P={},i(P,U.resolved,"success"),i(P,U.rejected,"failure"),i(P,U.error,"error"),i(P,U.aborted,"aborted"),P),M=(D={},i(D,U.error,!0),i(D,U.resolved,!0),i(D,U.rejected,!0),i(D,U.aborted,!0),D),W=0,G={},J=void 0,q=void 0,z=Object.prototype.toString,H=void 0,K=[!0,1,[],function(){},H,{}],Q=/\s+(\w+)]/,V=0,X=K.length;X>V;V++)J=(q=z.call(K[V])).replace("DOMWindow","Undefined"),G["is"+J.match(Q)[1]]=u(q);var Y=Array.prototype.slice,Z={staticLastSafeError:null,staticParentTask:null,staticSecurityLock:null},$={trace:!1,timeLimit:100,timeoutAmount:0,debug:!1},tt={trace:!1,timeLimit:100,timeoutAmount:0,debug:!1},nt=[].slice,et=function(t,n,e,r){function i(){if(!M[t.state]){t.state=U.error;for(var n=arguments.length,e=Array(n),r=0;n>r;r++)e[r]=arguments[r];t.value=e,o(e,R.error,p)}}function o(t,n,e){b.apply(this,[n].concat(t)),e&&c.call(l,0,e,[t])}function a(n,e){c(1,function(){n.runCount+e.runCount>0||(Z.staticSecurityLock=!0,n._signalIdle(),Z.staticSecurityLock=!0,e._signalIdle(),delete t.parentTask,delete e.childTask)})}function u(n){n.runCount=Math.max(0,n.runCount-1),n.runCount||(delete n.isAborted,delete n.isPaused,n.childTask?a(n.childTask,n):t.parentTask?a(n,t.parentTask):c(1,function(){n.runCount||(Z.staticSecurityLock=!0,n._signalIdle())}))}var l=t.task,f=t.parentTask,d=v(r.resolve),p=v(r.reject),y=h(e),b=g(y.trigger,n.trigger);return f&&(f.childTask=l),{setupInit:function(n){return tt.trace&&console.log("setupInit",new Date-0),M[t.state]?void 0:G.isUndefined(n)||G.isFunction(n)?void(t.initFn=v(l,n)):i("Crunch.description.initSetup","Init setup expects an optional parameter of type function only.")},setupBody:function(n,e,r){if(tt.trace&&console.log("setupBody",new Date-0),!M[t.state]){if(!G.isFunction(n))return i("CrunchTask.description.bodySetup","Body setup expects a function as the first optional arg.");if(!G.isUndefined(e)&&!G.isBoolean(e)&&!G.isNumber(e))return i("CrunchTask.description.bodySetup","Body setup expects a number or false as the second optional arg.");if(!G.isUndefined(r)&&!G.isNumber(r))return i("CrunchTask.description.bodySetup","Body setup expects a number as the 3rd optional arg.");t.bodyFn=v(l,n),t.conditionsToMeet--,t.needRepeat=e,t.timeoutAmount=r}},setupFin:function(n){return tt.trace&&console.log("setupFin",new Date-0),M[t.state]?void 0:G.isUndefined(n)||G.isFunction(n)?void(t.finallyFn=v(l,n)):i("CrunchTask.description.finSetup","Fin setup expects a function as a first optional arg.")},runEventsOn:y.on,signalError:i,goRunning:function(){l.runCount++,t.state=U.running,n.trigger(R.run,t.id)},resolve:function(){if(!M[t.state]){t.state=U.resolved;for(var n=arguments.length,e=Array(n),r=0;n>r;r++)e[r]=arguments[r];t.value=e,u(l),o(e,R.done,d)}},reject:function(){if(!M[t.state]){t.state=U.rejected;for(var n=arguments.length,e=Array(n),r=0;n>r;r++)e[r]=arguments[r];t.value=e,u(l),o(e,R.fail,p)}},abort:function(){return M[t.state]?void 0:(t.state=U.aborted,this)},pause:function(){return M[t.state]?void 0:(t.state=U.paused,this)},resume:function(){return M[t.state]?void 0:(t.state=U.running,this)},sendNotify:s(b,R.progress)}},rt=function(t){function i(t,r){return n(this,i),e(this,Object.getPrototypeOf(i).call(this,"CT_"+t+". Message: "+r))}return r(i,t),i}(Error),it=function(){function t(){n(this,t);for(var e=arguments.length,r=Array(e),i=0;e>i;i++)r[i]=arguments[i];(r.length>1||!G.isArray(r[0]))&&m("Ranges","Pass strictly a single arguments of type array");var o=r[0];this.data=A(O(o))}return I(t,[{key:"toString",value:function(){return w.apply(this)}},{key:"valueOf",value:function(){return w.apply(this)}},{key:"canAdvance",value:function(t){var n,e,r,i=0,o=this.data,a=o.length;do e=!1,n=o[i],t!==!0&&(n.current+=n.step),(!n.inclusive&&n.current===n.to||(n.step>0?n.current>n.to:n.current<n.to))&&(n.current=n.from,e=!0,i++),r=a>i;while(e&&r);return!e&&r}}]),t}(),ot=function(){var t=G.getTaskType();return new t(function(t,n){return n(function(t){return t()})})},at=function lt(t){return n(this,lt),new Promise(t)},ut=function(t){function i(t,r,o,u){n(this,i);var l=null,f=e(this,Object.getPrototypeOf(i).call(this,function(t,n){l={resolve:t,reject:n}})),d=Z.staticParentTask;Z.staticParentTask=null;var p={task:t,parentTask:d,id:"T_"+t.id+":"+a(),conditionsToMeet:1,state:U.init,runBlock:0,runArgs:u,descriptionFn:r},h=et(p,o,f,l);return Object.assign(f,{onError:s(f,h.runEventsOn,R.error),abort:s(f,h.abort),pause:s(f,h.pause),resume:s(f,h.resume),done:s(f,h.runEventsOn,R.done),fail:s(f,h.runEventsOn,R.fail),always:s(f,h.runEventsOn,[R.done,R.fail,R.error].join()),progress:s(f,h.runEventsOn,R.progress)}),c.call(p,0,b,[h]),f}return r(i,t),i}(at),st=function ft(t,e){n(this,ft);var r=void 0,i=void 0;try{return r=function(){for(var n=arguments.length,r=Array(n),o=0;n>o;o++)r[o]=arguments[o];return new ut(t,e,i,r)}}finally{t.events=i=h(r)}},ct=function(t){function i(t){n(this,i);var r={id:a(),timestamp:new Date-0,runCount:0},o=e(this,Object.getPrototypeOf(i).call(this,r,t)),u=o,c=function(){for(var n=arguments.length,e=Array(n),r=0;n>r;r++)e[r]=arguments[r];var o=function(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];for(var i=void 0;i=(e||[]).shift();)l(i)(n)},a=void 0;try{a=new i(t)}finally{a.done(o),u.done(o)}},f=null;if(tt.debug)try{throw new Error}catch(d){f=d.stack}var p=r.events;return delete r.events,Object.assign(o,{then:c,onRun:s(p.on,R.run),onIdle:s(p.on,R.idle),onError:s(p.on,R.error),done:s(p.on,R.done),fail:s(p.on,R.fail),always:s(p.on,[R.done,R.fail,R.error].join()),progress:s(p.on,R.progress),isIdle:function(){return 0===r.runCount},pause:function(){return r.isPaused=!0,u},resume:function(){return delete r.isPaused,u},abort:function(){return r.isAborted=!0,u}}),Object.assign(r,{stack:f,_signalIdle:function(){Z.staticSecurityLock&&(Z.staticSecurityLock=!1,p.trigger(R.idle))}}),o}return r(i,t),i}(st);Object.assign(ct,{"for":F,range:F,rangeCheck:E,rangeNextAndCheck:function(t,n){return t.canAdvance(n)},forEach:C,reduce:B,config:function dt(t){if(!G.isObject(t))return dt($);var n={},e={}.hasOwnProperty;for(var r in t)e.call(t,r)&&e.call(tt,r)&&(tt[r]=t[r],n[r]=t[r]);return n}}),Object.assign(G,{isBuddy:function(t){return t instanceof ct},getTaskType:function(){return ct}}),t.exports=ct});
//# sourceMappingURL=dist/Crunch.min.js.map