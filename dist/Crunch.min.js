!function(t,n){if("function"==typeof define&&define.amd)define("Crunch",["module"],n);else if("undefined"!=typeof exports)n(module);else{var e={exports:{}};n(e),t.Crunch=e.exports}}(this,function(t){"use strict";function n(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function e(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n}function r(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):t.__proto__=n)}function i(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}function o(t){var n=arguments.length<=1||void 0===arguments[1]?"":arguments[1];for(var e in t)B.call(t,e)&&(t[e]=n+e);return t}function a(t){return function(n){return q.call(n)===t}}function u(t,n){return W.isFunction(t)?function(e){return t.apply(n||this,e)}:W.isBuddy(t)?function(e){return K.staticParentTask=n,t.apply(t,e)}:function(t){return t}}function s(t){return W.isFunction(t)||W.isBuddy(t)}function c(t,n,e){if(e||W.isFunction(e)){for(var r=n.split(/\s*,\s*/),i=void 0,o=void 0,a=arguments.length,u=Array(a>3?a-3:0),s=3;a>s;s++)u[s-3]=arguments[s];for(;i=r.shift();)(o=t[i])?o.push([e,u]):t[i]=[[e,u]]}}function l(t,n){if(t[n]){for(var e=t[n],r=arguments.length,i=Array(r>2?r-2:0),o=2;r>o;o++)i[o-2]=arguments[o];for(var a=0,u=e.length;u>a;a++){var s=C(e[a],2),c=s[0],l=s[1];if(c)try{c.apply(this,[].concat(l,i))}catch(f){$.debug&&console.log(f+", stack: "+f.stack)}}}}function f(t){var n=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];return{on:c.bind(t,n),trigger:l.bind(t,n)}}function d(t,n){return W.isFunction(t)&&(n=t,t=this),W.isFunction(n)||(n=function(){}),function(){var e=tt.call(arguments,0);try{return n.apply(t,e),!0}catch(r){return K.staticLastSafeError=r,$.debug&&console.log(r+", stack: "+r.stack),!1}}}function h(){var t=tt.call(arguments,0);return function(){for(var n,e=tt.call(arguments,0),r=[].concat(t);(n=r.shift())&&W.isFunction(n);)n.apply(this,e)}}function v(){var t=this,n=arguments[0],e=tt.call(arguments,1);return!W.isFunction(n)&&W.isFunction(e[0])&&(t=arguments[0],n=e.shift()),function(){var r=tt.call(arguments);return n.apply(t,[].concat(e,r))}}function p(t,n,e){var r=this;return setTimeout(function(){n.apply(r,e||[])},t||0)}function g(t,n){$.trace&&(console.log("inside proceedBodyFn",this.id,new Date-0),console.log("isFirstTime",n),console.log("this.timeoutAmount",this.timeoutAmount)),p.call(this,n?0:this.timeoutAmount,function(t){$.trace&&console.log("inside proceedBodyFn:defer",this.id,new Date-0);var n=this.task,e=this.needRepeat,r=W.isNumber(e)?e:0,i=void 0,o=void 0,a=0,u=0,s=this.state===M.running&&!n.isPaused&&!n.isAborted,c=void 0,l=void 0;if(s){i=new Date-0;do{try{o=new Date,this.bodyFn(t.resolve,t.reject,t.sendNotify,{batchStarted:i,batchIndex:a,batchElapsed:u,runBlock:this.runBlock})}catch(f){$.debug&&console.log(f+", stack: "+f.stack),t.signalError(x.TASK_BODY_INSIDE,f)}u+=new Date-o,a++,c=e&&0!==r&&r>u&&this.state===M.running}while(c)}else(n.isAborted||this.state===M.aborted)&&t.reject("aborted");return(l=e&&L[this.state]&&!n.isAborted)?(this.runBlock++,$.trace&&console.log("rescheduling proceedBodyFn",this.id,new Date-0),g.call(this,t)):(e===!1&&t.resolve(),void(this.finallyFn&&!this.finallyFn.call(this,U[this.state])&&t.signalError(x.TASK_FIN_INSIDE,this.status)))},[t])}function I(t){var n=this,e=n.task,r=n.descriptionFn;if(!r)return t.signalError(x.DESCRIPTION_FN_MISS,"Description function is empty. Ctx:"+JSON.stringify(n));if($.trace&&console.log("before descriptionFn run",new Date-0),!d(e,r)(t.setupInit,t.setupBody,t.setupFin)||Y[n.state]||0!==n.conditionsToMeet){var i=K.staticLastSafeError;return delete K.staticLastSafeError,t.signalError(x.DESCRIPTION_INSIDE,i.message)}$.trace&&console.log("after descriptionFn run",new Date-0);var o=n.needRepeat;o=o===!1?o:0===o?o:o||$.timeLimit,n.needRepeat=0===o?!0:o,n.timeoutAmount=n.timeoutAmount||$.timeoutAmount,$.trace&&(console.log("collected `needRepeat`:",n.needRepeat),console.log("collected `timeoutAmount`:",n.timeoutAmount)),t.goRunning(),$.trace&&console.log("before deferred Init + Body scheduler",new Date-0),p.call(n,0,function(){$.trace&&console.log("inside deferred Init + Body scheduler. With args:",new Date-0,this.runArgs.join()),this.initFn&&!this.initFn.apply(this,this.runArgs)&&t.signalError(x.TASK_INIT_INSIDE),$.trace&&console.log("before  proceedBodyFn",new Date-0),g.call(this,t,!0)})}function y(t,n){throw W.isUndefined(n)&&(n=t,t="Generic"),new et(t,n)}function S(t,n){for(var e=new Array(t.length),r=0,i=t.length;i>r;r++)e[r]=n(t[r],r);return e}function _(){return S(this.data,function(t){return t.current})}function O(t){return S(t,T)}function T(t){var n=t.length,e=n-1,r=W.isBoolean(t[e]),i=void 0;switch(n-(r?1:0)){case 2:case 3:return i=n-(r?1:0)===3?t[2]:t[0]<=t[1]?1:-1,{from:t[0],current:t[0],to:t[1],step:i,inclusive:r?t[n-1]:!1};case 0:case 1:y("Ranges","Use at least two values to define a range.");break;default:n%2===0&&n%3===0?y("Ranges","Use arrays to split range parts. Cannot determine pattern now."):y("Ranges","Use arrays to split range parts properly.")}}function m(t,n){for(var e=[],r=[],i=void 0,o=void 0;t.length;)i=t.splice(0,1)[0],o=W.isArray(i),o&&n!==!0?(r.length&&(e.push(r),r=[]),e.push(m(i,!0))):W.isBoolean(i)?(r.push(i),e.push(r),r=[]):W.isNumber(i)&&r.push(i);return r.length&&e.push(r),n===!0?e[0]:e}function b(){for(var t=arguments.length,n=Array(t),e=0;t>e;e++)n[e]=arguments[e];for(var r=n.length,i=0;s(n[r-1-i]);)i++;var o=n.slice(0,r-i),a=new rt(o),u=n.slice(-i),c=C(u,2),l=c[0],f=c[1],d=void 0===f?function(){}:f;return l?N(a,l,d):it()}function N(t,n,e){var r=W.getTaskType();return new r(function(r,i,o){var a=u(n,this),s=u(e,this),c=t,l=void 0;r(function(){for(var t=arguments.length,n=Array(t),e=0;t>e;e++)n[e]=arguments[e];n.length&&(c=new rt(n)),l=c.canAdvance(!0)}),i(function(t){l&&a(c.valueOf()),l&&c.canAdvance()||t()},$.timeLimit,$.timeoutAmount),o(function(){s(c.valueOf())})})}function E(t,n,e){var r=W.getTaskType();return new r(function(r,i,o){var a=u(n,this),s=u(e,this),c=void 0,l=void 0,f=t,d=void 0;r(function(n){n&&(f=t),c=new rt([0,f.length]),d=c.canAdvance(!0)}),i(function(t){d&&(l=c.valueOf()[0],a([f[l],l])),d&&c.canAdvance()||t()},$.timeLimit,$.timeoutAmount),o(function(){s(c.valueOf())})})}function D(){for(var t=arguments.length,n=Array(t),e=0;t>e;e++)n[e]=arguments[e];return new rt(n)}function A(t,n,e,r){var i=W.getTaskType();return new i(function(i,o,a){var s=u(e,this),c=u(r,this),l=void 0,f=void 0,d=t,h=n,v=void 0;i(function(n,e){n&&(d=t),l=new rt([0,d.length]),v=l.canAdvance(!0),W.isUndefined(e)||(h=e)}),o(function(t){v&&(f=l.valueOf()[0],h=s([h,d[f],f])),v&&l.canAdvance()||t(h)},$.timeLimit,$.timeoutAmount),a(function(){c(h,l.valueOf())})})}function w(){return++ot}for(var F,k,R,P=(function(){function t(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(n,e,r){return e&&t(n.prototype,e),r&&t(n,r),n}}()),C=(function(){function t(t,n){var e=[],r=!0,i=!1,o=void 0;try{for(var a,u=t[Symbol.iterator]();!(r=(a=u.next()).done)&&(e.push(a.value),!n||e.length!==n);r=!0);}catch(s){i=!0,o=s}finally{try{!r&&u["return"]&&u["return"]()}finally{if(i)throw o}}return e}return function(n,e){if(Array.isArray(n))return n;if(Symbol.iterator in Object(n))return t(n,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}()),B={}.hasOwnProperty,j=o({run:null,done:null,fail:null,abort:null,error:null,progress:null,idle:null},"event."),M=o({init:null,error:null,running:null,paused:null,resolved:null,rejected:null,aborted:null},"state."),L=(F={},i(F,M.running,!0),i(F,M.paused,!0),F),U=(k={},i(k,M.resolved,"success"),i(k,M.rejected,"failure"),i(k,M.error,"error"),i(k,M.aborted,"aborted"),k),Y=(R={},i(R,M.error,!0),i(R,M.resolved,!0),i(R,M.rejected,!0),i(R,M.aborted,!0),R),x={DESCRIPTION_FN_MISS:"DESCRIPTION_FN_MISS",DESCRIPTION_INSIDE:"DESCRIPTION_INSIDE",DESCRIPTION_INIT_FN_MISS:"DESCRIPTION_INIT_FN_MISS",TASK_INIT_INSIDE:"TASK_INIT_INSIDE",TASK_BODY_INSIDE:"TASK_BODY_INSIDE",TASK_FIN_INSIDE:"TASK_FIN_INSIDE",DESCRIPTION_BODY_FN_MISS:"DESCRIPTION_BODY_FN_MISS",DESCRIPTION_BODY_REPEAT_WRONG:"DESCRIPTION_BODY_REPEAT_WRONG",DESCRIPTION_BODY_TIMEOUT_WRONG:"DESCRIPTION_BODY_TIMEOUT_WRONG",DESCRIPTION_FIN_FN_MISS:"DESCRIPTION_FIN_FN_MISS"},K={staticLastSafeError:null,staticParentTask:null,staticSecurityLock:null},W={},G=void 0,J=void 0,q=Object.prototype.toString,z=void 0,H=[!0,1,[],function(){},z,{}],Q=/\s+(\w+)]/,V=0,X=H.length;X>V;V++)G=(J=q.call(H[V])).replace("DOMWindow","Undefined"),W["is"+G.match(Q)[1]]=a(J);var Z={trace:!1,timeLimit:100,timeoutAmount:0,debug:!1},$={trace:!1,timeLimit:100,timeoutAmount:0,debug:!1},tt=Array.prototype.slice,nt=function(t,n,e,r){function i(){if(!Y[t.state]){t.state=M.error;for(var n=arguments.length,e=Array(n),r=0;n>r;r++)e[r]=arguments[r];t.value=e,o(e,j.error,g)}}function o(t,n,e){y.apply(this,[n].concat(t)),e&&p.call(s,0,e,[t])}function a(n,e){p(1,function(){n.runCount+e.runCount>0||(K.staticSecurityLock=!0,n._signalIdle(),K.staticSecurityLock=!0,e._signalIdle(),delete t.parentTask,delete e.childTask)})}function u(n){n.runCount=Math.max(0,n.runCount-1),n.runCount||(delete n.isAborted,delete n.isPaused,n.childTask?a(n.childTask,n):t.parentTask?a(n,t.parentTask):p(1,function(){n.runCount||(K.staticSecurityLock=!0,n._signalIdle())}))}var s=t.task,c=t.parentTask,l=d(r.resolve),g=d(r.reject),I=f(e),y=h(I.trigger,n.trigger);return c&&(c.childTask=s),{setupInit:function(n){return $.trace&&console.log("setupInit",new Date-0),Y[t.state]?void 0:W.isUndefined(n)||W.isFunction(n)?void(t.initFn=d(s,n)):i(x.DESCRIPTION_INIT_FN_MISS)},setupBody:function(n,e,r){if($.trace&&console.log("setupBody",new Date-0),!Y[t.state]){if(!W.isFunction(n))return i(x.DESCRIPTION_BODY_FN_MISS);if(!W.isUndefined(e)&&!W.isBoolean(e)&&!W.isNumber(e))return i(x.DESCRIPTION_BODY_REPEAT_WRONG);if(!W.isUndefined(r)&&!W.isNumber(r))return i(x.DESCRIPTION_BODY_TIMEOUT_WRONG);t.bodyFn=d(s,n),t.conditionsToMeet--,t.needRepeat=e,t.timeoutAmount=r}},setupFin:function(n){return $.trace&&console.log("setupFin",new Date-0),Y[t.state]?void 0:W.isUndefined(n)||W.isFunction(n)?void(t.finallyFn=d(s,n)):i(x.DESCRIPTION_FIN_FN_MISS)},runEventsOn:I.on,signalError:i,goRunning:function(){s.runCount++,t.state=M.running,n.trigger(j.run,t.id)},resolve:function(){if(!Y[t.state]){t.state=M.resolved;for(var n=arguments.length,e=Array(n),r=0;n>r;r++)e[r]=arguments[r];t.value=e,u(s),o(e,j.done,l)}},reject:function(){if(!Y[t.state]){t.state=M.rejected;for(var n=arguments.length,e=Array(n),r=0;n>r;r++)e[r]=arguments[r];t.value=e,u(s),o(e,j.fail,g)}},abort:function(){return Y[t.state]?void 0:(t.state=M.aborted,this)},pause:function(){return Y[t.state]?void 0:(t.state=M.paused,this)},resume:function(){return Y[t.state]?void 0:(t.state=M.running,this)},sendNotify:v(y,j.progress)}},et=function(t){function i(t,r){return n(this,i),e(this,Object.getPrototypeOf(i).call(this,"CT_"+t+". Message: "+r))}return r(i,t),i}(Error),rt=function(){function t(){n(this,t);for(var e=arguments.length,r=Array(e),i=0;e>i;i++)r[i]=arguments[i];(r.length>1||!W.isArray(r[0]))&&y("Ranges","Pass strictly a single arguments of type array");var o=r[0];this.data=O(m(o))}return P(t,[{key:"toString",value:function(){return _.apply(this)}},{key:"valueOf",value:function(){return _.apply(this)}},{key:"canAdvance",value:function(t){var n,e,r,i=0,o=this.data,a=o.length;do e=!1,n=o[i],t!==!0&&(n.current+=n.step),(!n.inclusive&&n.current===n.to||(n.step>0?n.current>n.to:n.current<n.to))&&(n.current=n.from,e=!0,i++),r=a>i;while(e&&r);return!e&&r}}]),t}(),it=function(){var t=W.getTaskType();return new t(function(t,n){return n(function(t){return t()})})},ot=0,at=function lt(t){return n(this,lt),new Promise(t)},ut=function(t){function i(t,r,o,a){n(this,i);var u=null,s=e(this,Object.getPrototypeOf(i).call(this,function(t,n){u={resolve:t,reject:n}})),c=K.staticParentTask;K.staticParentTask=null;var l={task:t,parentTask:c,id:"T_"+t.id+":"+w(),conditionsToMeet:1,state:M.init,runBlock:0,runArgs:a,descriptionFn:r},f=nt(l,o,s,u);return Object.assign(s,{onError:v(s,f.runEventsOn,j.error),abort:v(s,f.abort),pause:v(s,f.pause),resume:v(s,f.resume),done:v(s,f.runEventsOn,j.done),fail:v(s,f.runEventsOn,j.fail),always:v(s,f.runEventsOn,[j.done,j.fail,j.error].join()),progress:v(s,f.runEventsOn,j.progress)}),p.call(l,0,I,[f]),s}return r(i,t),i}(at),st=function ft(t,e){n(this,ft);var r=void 0,i=void 0;try{return r=function(){for(var n=arguments.length,r=Array(n),o=0;n>o;o++)r[o]=arguments[o];return new ut(t,e,i,r)}}finally{t.events=i=f(r)}},ct=function(t){function i(t,r){n(this,i);var o={id:w(),timestamp:new Date-0,runCount:0,token:r},a=e(this,Object.getPrototypeOf(i).call(this,o,t)),s=a,c=function(){for(var n=arguments.length,e=Array(n),r=0;n>r;r++)e[r]=arguments[r];var o=function(){for(var t=arguments.length,n=Array(t),r=0;t>r;r++)n[r]=arguments[r];for(var i=void 0;i=(e||[]).shift();)u(i)(n)},a=void 0;try{a=new i(t)}finally{a.done(o),s.done(o)}},l=null;if($.debug)try{throw new Error}catch(f){l=f.stack}var d=o.events;return delete o.events,Object.assign(a,{then:c,onRun:v(d.on,j.run),onIdle:v(d.on,j.idle),onError:v(d.on,j.error),done:v(d.on,j.done),fail:v(d.on,j.fail),always:v(d.on,[j.done,j.fail,j.error].join()),progress:v(d.on,j.progress),isIdle:function(){return 0===o.runCount},pause:function(){return o.isPaused=!0,s},resume:function(){return delete o.isPaused,s},abort:function(){return o.isAborted=!0,s}}),Object.assign(o,{stack:l,_signalIdle:function(){K.staticSecurityLock&&(K.staticSecurityLock=!1,d.trigger(j.idle))}}),a}return r(i,t),i}(st);Object.assign(ct,{"for":b,range:b,rangeCheck:D,rangeNextAndCheck:function(t,n){return t.canAdvance(n)},forEach:E,reduce:A,config:function dt(t){if(!W.isObject(t))return dt(Z);var n={},e={}.hasOwnProperty;for(var r in t)e.call(t,r)&&e.call($,r)&&($[r]=t[r],n[r]=t[r]);return n}}),Object.assign(W,{isBuddy:function(t){return t instanceof ct},getTaskType:function(){return ct}}),t.exports=ct});
//# sourceMappingURL=dist/Crunch.min.js.map