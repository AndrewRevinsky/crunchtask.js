/*! crunchtask - v0.6.0 - 2015-03-10 */!function(){function a(a,b){return function(){a.apply(b,arguments)}}function b(b){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof b)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],h(b,a(d,this),a(e,this))}function c(a){var b=this;return null===this._state?void this._deferreds.push(a):void j(function(){var c=b._state?a.onFulfilled:a.onRejected;if(null===c)return void(b._state?a.resolve:a.reject)(b._value);var d;try{d=c(b._value)}catch(e){return void a.reject(e)}a.resolve(d)})}function d(b){try{if(b===this)throw new TypeError("A promise cannot be resolved with itself.");if(b&&("object"==typeof b||"function"==typeof b)){var c=b.then;if("function"==typeof c)return void h(a(c,b),a(d,this),a(e,this))}this._state=!0,this._value=b,f.call(this)}catch(g){e.call(this,g)}}function e(a){this._state=!1,this._value=a,f.call(this)}function f(){for(var a=0,b=this._deferreds.length;b>a;a++)c.call(this,this._deferreds[a]);this._deferreds=null}function g(a,b,c,d){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.resolve=c,this.reject=d}function h(a,b,c){var d=!1;try{a(function(a){d||(d=!0,b(a))},function(a){d||(d=!0,c(a))})}catch(e){if(d)return;d=!0,c(e)}}var i;i="object"==typeof window&&window?window:global,"undefined"!=typeof module&&module.exports?module.exports=i.Promise?i.Promise:b:i.Promise||(i.Promise=b);var j=i.setImmediate||function(a){setTimeout(a,1)},k=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)};b.prototype["catch"]=function(a){return this.then(null,a)},b.prototype.then=function(a,d){var e=this;return new b(function(b,f){c.call(e,new g(a,d,b,f))})},b.all=function(){var a=Array.prototype.slice.call(1===arguments.length&&k(arguments[0])?arguments[0]:arguments);return new b(function(b,c){function d(f,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(a){d(f,a)},c)}a[f]=g,0===--e&&b(a)}catch(i){c(i)}}if(0===a.length)return b([]);for(var e=a.length,f=0;f<a.length;f++)d(f,a[f])})},b.resolve=function(a){return a&&"object"==typeof a&&a.constructor===b?a:new b(function(b){b(a)})},b.reject=function(a){return new b(function(b,c){c(a)})},b.race=function(a){return new b(function(b,c){for(var d=0,e=a.length;e>d;d++)a[d].then(b,c)})}}(),function(){"use strict";function a(a){return M.isFunction(a)||a instanceof x}function b(a,b){throw M.isUndefined(b)&&(b=a,a="Generic"),new Error(["`CT_",a,"`. Message: ",b].join(""))}function c(){return++O}function d(a,b){for(var c in a)L.call(a,c)&&(a[c]=b+c);return a}function e(a,b){for(var c={},d=M.isArray(b),e=0,f=a.length;f>e;e++)c[a[e]]=d?b[e]:b;return c}function f(a,b){for(var c in b)L.call(b,c)&&(a[c]=b[c]);return a}function g(){var a=this,b=arguments[0],c=K.call(arguments,1);return!M.isFunction(b)&&M.isFunction(c[0])&&(a=arguments[0],b=c.shift()),function(){var d=K.call(arguments,0);return b.apply(a,[].concat(c,d))}}function h(a,b){var c=K.call(arguments,2);return function(){var d=K.call(arguments,0);return b.apply(a,[].concat(c,d))||a}}function i(){var a=K.call(arguments,0);return function(){for(var b,c=K.call(arguments,0);(b=a.shift())&&M.isFunction(b);)b.apply(this,c)}}function j(a,b,c){if(c)for(var d,e,f=K.call(arguments,3),g=b.split(/\s*,\s*/);d=g.shift();)(e=a[d])?e.push([c,f]):a[d]=[[c,f]]}function k(a,b){var c=K.call(arguments,2);if(1===c.length&&M.isArray(c[0])&&(c=c[0]),a[b])for(var d,e,f,g=a[b],h=0,i=g.length;i>h;h++)if(d=g[h],e=d[0],f=d[1],e)try{e.apply(this,[].concat(f,c))}catch(j){console.info(j)}}function l(a,b,c){var d=this;return setTimeout(function(){b.apply(d,c||[])},a||0)}function m(a,b){return M.isFunction(a)&&(b=a,a=this),M.isUndefined(b)&&(b=function(){}),function(){var c=K.call(arguments,0);try{return b.apply(a,c),!0}catch(d){return!1}}}function n(a,b){var d=this,e={},f={task:d,id:"T_"+d.id+":"+c(),conditionsToMeet:1,state:Q.init,runBlock:0,runArgs:K.call(arguments,2),descriptionFn:a},h=null,i=function(a,c){h=g(f,p,e,b,{resolve:a,reject:c}),l.call(f,0,q,[e])};return o(new N(i),e,h)}function o(a,b,c){return c(a),f(a,{onError:g(a,b.runEventsOn,P.error),abort:g(a,b.abort),pause:g(a,b.pause),resume:g(a,b.resume),done:g(a,b.runEventsOn,P.done),fail:g(a,b.runEventsOn,P.fail),always:g(a,b.runEventsOn,[P.done,P.fail,P.error].join())})}function p(a,b,c,d){function e(){if(!R[k.state]){var a=K.call(arguments,0);k.state=Q.error,k.value=a,h(a,P.error,p)}}function h(a,b,c){r.apply(this,[b].concat(a)),c&&l.call(n,0,c,[a])}function j(a){a.runCount&&(a.runCount--,a.runCount||(delete a.isAborted,delete a.isPaused,l(1,g(a,b.trigger,P.idle))))}var k=this,n=k.task,o=m(c.resolve),p=m(c.reject),q=w(d),r=i(q.trigger,b.trigger);return f(a,{setupInit:function(a){return R[k.state]?void 0:M.isUndefined(a)||M.isFunction(a)?void(k.initFn=m(n,a)):e("CrunchTask.description.initSetup","Init setup expects an optional function.")},setupBody:function(a,b,c){if(!R[k.state]){if(!M.isFunction(a))return e("CrunchTask.description.bodySetup","Body setup expects a function as a first optional arg.");if(!M.isUndefined(b)&&!M.isBoolean(b)&&!M.isNumber(b))return e("CrunchTask.description.bodySetup","Body setup expects a number or false as a 2nd optional arg.");if(!M.isUndefined(c)&&!M.isNumber(c))return e("CrunchTask.description.bodySetup","Body setup expects a number as a 3rd optional arg.");k.bodyFn=m(n,a),k.conditionsToMeet--,k.needRepeat=b!==!1?b||0:b,k.timeoutAmount=c}},setupFin:function(a){return R[k.state]?void 0:M.isUndefined(a)||M.isFunction(a)?void(k.finallyFn=m(n,a)):e("CrunchTask.description.finSetup","Fin setup expects a function as a first optional arg.")},signalError:e,runEventsOn:q.on,goRunning:function(){n.runCount++,k.state=Q.running,b.trigger(P.run,k.id)},resolve:function(){if(!R[k.state]){var a=K.call(arguments,0);k.state=Q.resolved,k.value=a,j(n),h(a,P.done,o)}},reject:function(){if(!R[k.state]){var a=K.call(arguments,0);k.state=Q.rejected,k.value=a,j(n),h(a,P.fail,p)}},abort:function(){return R[k.state]?void 0:(k.state=Q.aborted,this)},pause:function(){return R[k.state]?void 0:(k.state=Q.paused,this)},resume:function(){return R[k.state]?void 0:(k.state=Q.running,this)},sendNotify:g(r,P.progress)})}function q(a){var b=this,c=b.task,d=b.descriptionFn;if(!d)return a.signalError("CrunchTask.description.empty","Description function is empty.");if(!m(c,d)(a.setupInit,a.setupBody,a.setupFin)||R[b.state]||0!==b.conditionsToMeet)return a.signalError("CrunchTask.description.else","");var e=b.needRepeat;e=e!==!1?e||0:e,b.needRepeat=0===e?!0:e,b.timeoutAmount=b.timeoutAmount||0,l.call(b,0,function(){a.goRunning(),this.initFn&&!this.initFn.apply(this,this.runArgs)&&a.signalError("CrunchTask.description.init"),r.call(this,a)})}function r(a){this.currentTimeout=l.call(this,this.timeoutAmount,function(a){delete this.currentTimeout;var b,c,d,e,f=this.task,g=this.needRepeat,h=M.isNumber(g)?g:0,i=0,j=0,k=this.state===Q.running&&!f.isPaused&&!f.isAborted;if(k){b=new Date;do{try{c=new Date,this.bodyFn(a.resolve,a.reject,a.sendNotify,{batchStarted:b,batchIndex:i,batchElapsed:j,runBlock:this.runBlock})}catch(l){a.signalError("body",l)}j+=new Date-c,i++,d=g&&h>j&&this.state===Q.running}while(d)}else(f.isAborted||this.state===Q.aborted)&&a.reject("aborted");return(e=g&&S[this.state]&&!f.isAborted)?(this.runBlock++,r.call(this,a)):(g===!1&&a.resolve(),void(this.finallyFn&&!this.finallyFn.call(this,T[this.state])&&a.signalError("CrunchTask.description.fin",this.status)))},[a])}function s(){return this.isAborted=!0,this}function t(){return this.isPaused=!0,this}function u(){return delete this.isPaused,this}function v(a){var b,c=K.call(arguments,1);try{return b=new x(a)}finally{b.done(function(){for(var a,b=K.call(arguments,0);a=c.shift();)a instanceof x&&a.run.apply(a,b)})}}function w(a,b){var c=b||{};return{on:h(a,j,c),trigger:h(a,k,c)}}function x(a){return this instanceof x?y(this,w(this),a):new x(a)}function y(a,b,d){return f(a,{id:c(),timestamp:new Date-0,runCount:0,isIdle:function(){return 0===a.runCount},pause:h(a,t),resume:h(a,u),abort:h(a,s),run:g(a,n,d,b),then:g(a,v,d),onRun:g(b.on,P.run),onIdle:g(b.on,P.idle),onError:g(b.on,P.error),done:g(b.on,P.done),fail:g(b.on,P.fail),always:g(b.on,[P.done,P.fail,P.error].join()),progress:g(b.on,P.progress)})}function z(){for(var b=arguments.length,c=0;a(arguments[b-1-c]);)c++;var d=K.call(arguments,0,b-c),e=K.call(arguments,-c),f=H(G(d)),g=e[0],h=e[1]||function(){};return g?B(f,g,h):C()}function A(){var a=K.call(arguments,0);return H(G(a))}function B(a,b,c){return new x(function(d,e,f){var g,h=a;d(function(){var a=K.call(arguments,0);a.length&&(h=H(G(a))),g=F(h,!0)}),e(function(a){g&&D(b,E(h)),g&&F(h)||a()},100),f(function(){D(c,E(h))})})}function C(){return new x(function(a,b){b(function(a){a()})})}function D(a,b){M.isFunction(a)?a.apply(this,b):a instanceof x&&a.run.apply(a,b)}function E(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(a[c].current);return b}function F(a,b){var c,d,e,f=0,g=a.length;do d=!1,c=a[f],b!==!0&&(c.current+=c.step),(!c.inclusive&&c.current===c.to||(c.step>0?c.current>c.to:c.current<c.to))&&(c.current=c.from,d=!0,f++),e=g>f;while(d&&e);return!d&&e}function G(a,b){for(var c,d,e=[],f=[];a.length;)c=a.splice(0,1)[0],d=M.isArray(c),d&&b!==!0?(f.length&&(e.push(f),f=[]),e.push(G(c,!0))):M.isBoolean(c)?(f.push(c),e.push(f),f=[]):M.isNumber(c)&&f.push(c);return f.length&&e.push(f),b===!0?e[0]:e}function H(a){for(var b=[],c=0,d=a.length;d>c;c++)b.push(I(a[c]));return b}function I(a){var c,d=a.length,e=d-1,f=M.isBoolean(a[e]);switch(d-(f?1:0)){case 2:case 3:return c=d-(f?1:0)===3?a[2]:a[0]<=a[1]?1:-1,{from:a[0],current:a[0],to:a[1],step:c,inclusive:f?a[d-1]:!1};case 0:case 1:b("Ranges","Use at least two values to define a range.");break;default:d%2===0&&d%3===0?b("Ranges","Use arrays to split range parts. Cannot determine pattern now."):b("Ranges","Use arrays to split range parts properly.")}}var J="object"==typeof window&&window?window:global,K=[].slice,L={}.hasOwnProperty,M=function(){function a(a){return function(b){return f.call(b)===a}}for(var b,c,d,e={},f=Object.prototype.toString,g=[!0,1,[],function(){},b],h=/\s+(\w+)]/,i=0,j=g.length;j>i;i++)c=(d=f.call(g[i])).replace("DOMWindow","Undefined"),e["is"+c.match(h)[1]]=a(d);return e}(),N="undefined"!=typeof N?N:"undefined"!=typeof J.Promise?J.Promise:"undefined"!=typeof require?require("promise-polyfill"):!1;N===!1&&b("Linking",'Dependency isn\'t met: "promise-polyfill"'),"undefined"!=typeof module&&module.exports?module.exports=J.CrunchTask?J.CrunchTask:x:J.CrunchTask||(J.CrunchTask=x),x["for"]=z,x.range=z,x.rangeCheck=A,x.rangeNextAndCheck=F;var O=0,P=d({run:null,done:null,fail:null,abort:null,error:null,progress:null,idle:null},"event."),Q=d({init:null,error:null,running:null,paused:null,resolved:null,rejected:null,aborted:null},"state."),R=e([Q.error,Q.resolved,Q.rejected,Q.aborted],!0),S=e([Q.running,Q.paused],!0),T=e([Q.resolved,Q.rejected,Q.error,Q.aborted],["success","failure","error","aborted"])}();